# 3D LUT 色破綻問題 調査ツール（アーカイブ）

> **⚠️ RESOLVED**: この問題は解決済みです。解決策については `LUT_ISSUE_RESOLUTION_GUIDE.md` を参照してください。

## 🎯 目的（履歴）
WebGL を用いた3D LUT処理において、低い不透明度でも色が破綻する問題を特定し、Photoshop互換の自然な色変換を実現する。

## ✅ 解決済み事項
- **根本原因**: 3D→2D テクスチャ座標マッピングの不整合
- **解決策**: テクスチャレイアウトとシェーダー座標系の整合
- **追加改善**: Photoshop互換のシーケンシャルカスケードブレンディング実装

## 🚀 使用方法

### 1. 調査ツールの起動
```bash
# investigation フォルダで HTTP サーバーを起動
cd investigation
python3 -m http.server 8080
# または
npx serve .
```

ブラウザで `http://localhost:8080` にアクセス

### 2. 基本的な調査手順

#### Step 1: テストデータの準備
1. **テスト画像生成**: 「テスト画像生成」ボタンをクリック
2. **テストLUT生成**: 「テストLUT生成」ボタンをクリック
   - オレンジを強調するLUTが自動生成されます

#### Step 2: 基本的な問題の確認
1. 不透明度を26%に設定
2. スケーリング係数を1.0に設定
3. 処理後の画像でオレンジの強調具合を確認

#### Step 3: 仮説の検証
各仮説テストボタンをクリックして検証:

1. **ガンマ補正テスト**: sRGB ⇔ Linear変換の影響を確認
2. **補間精度テスト**: 標準精度 vs 高精度の比較
3. **スケーリングテスト**: 異なるスケーリング係数での動作確認

### 3. 色相テスト
- 画面下部の色見本をクリック
- 特定の色（純赤、オレンジなど）での変換結果を数値で確認
- RGB値の変化量を定量的に評価

## 🔍 調査のポイント

### 現在の仮説
1. **ガンマ補正の問題**: sRGB色空間での処理による色の非線形性
2. **LUT補間の精度問題**: Trilinear補間の計算精度不足
3. **不透明度スケーリング**: Photoshopとは異なるブレンド計算

### 重要な確認項目
- [ ] オレンジ色 `rgb(255, 128, 0)` での変換結果
- [ ] 不透明度26%でのPhotoshop比較
- [ ] ガンマ補正ON/OFFでの違い
- [ ] スケーリング係数0.3での自然な仕上がり

## 📊 調査結果の記録

### デバッグログの活用
- リアルタイムでパラメータと結果を記録
- 「結果エクスポート」で JSON ファイルとして保存
- 複数の設定での比較データを蓄積

### 期待される発見
1. **最適なスケーリング係数**: 0.3〜0.5の範囲
2. **ガンマ補正の必要性**: Linear RGB での処理が必要か
3. **補間方式の改善**: より正確なアルゴリズム

## 🛠️ カスタマイズ

### LUTファイルの読み込み
- `.cube` ファイルをドラッグ&ドロップ
- 実際の商用LUTでの動作確認
- Anderson、Blue Sierra等の実LUTでテスト

### テスト画像の追加
- 実際の写真でのテスト
- オレンジが含まれる風景写真推奨
- ポートレート、風景での色破綻確認

## 🔬 高度な調査

### シェーダーの修正
`script.js` 内の `fragmentShaderBasic` を編集:

```glsl
// 例: より正確な補間の実装
vec3 applyLUTHighPrecision(sampler2D lut, vec3 color) {
    // 改善されたアルゴリズムを実装
}
```

### 新しい仮説の追加
1. `testNewHypothesis()` 関数を追加
2. HTMLに新しいテストボタンを追加
3. 結果をデバッグログに記録

## 📈 成功基準

### 定量的評価
- [ ] RGB差分が10未満（0-255スケール）
- [ ] 不透明度50%でPhotoshopと同等の結果
- [ ] オレンジ領域での色破綻なし

### 定性的評価
- [ ] 自然な色の変化
- [ ] 過度な彩度上昇なし
- [ ] 肌色の保持

## 🐛 トラブルシューティング

### WebGL エラー
```javascript
// コンソールでWebGL状態確認
console.log("WebGL支援:", !!investigator.gl);
console.log("シェーダー状態:", !!investigator.program);
```

### LUT読み込みエラー
- `.cube` ファイルの形式確認
- LUT_3D_SIZE の値確認
- RGB値の範囲（0.0-1.0）確認

## 📝 次のステップ

### 調査完了後
1. 最適なパラメータの特定
2. 修正版シェーダーの実装
3. メインアプリケーションへの適用
4. 複数LUTでの動作確認
5. パフォーマンステスト

### レポート作成
調査結果を元に以下をまとめる:
- 問題の根本原因
- 解決策の詳細
- 実装上の注意点
- 推奨パラメータ